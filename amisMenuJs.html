<script>
//http://mikecostello.github.io/jquery-slide-text-left/
!function(e){function t(t,n,d,a){n.delay(d).animate({width:"toggle"},e.proxy(n.text,n,t)).animate({width:"toggle"},a)}e.fn.slideTextLeft=function(n,d){var a=!1,o=e.fn.slideTextLeft.defaults;return"number"==typeof d&&(o.delay=d),e.isArray(n)?o.words=n:"string"==typeof n?(o.words=n,a=!0):e.isPlainObject(n)&&(o=e.extend({},e.fn.slideTextLeft.defaults,n)),this.each(function(){var n=e(this),d=n.text(),s=e.meta?e.extend({},o,n.data()):o,i=0;s.words.length&&(n.css({"white-space":"nowrap",overflow:"hidden","vertical-align":"bottom"}),d.length&&d!==s.words[0]||(n.text(s.words[0]),i=1),function e(){var d=a?s.words:s.words[i],o=a?null:e;t(d,n,s.delay,o),i=(i+1)%s.words.length}())})},e.fn.slideTextLeft.defaults={words:[],delay:2e3}}(jQuery);
</script>

<script>
        var hideLoading, showLoading, userToken;

        /**
         * firebase user data
         * @type {Object}
         */
        var user_data = {};

       //-----------------------------------------------------------------
       // Initialize Firebase
       //-----------------------------------------------------------------
       var config = {
       	apiKey: "<?= apiKey ?>",
       	authDomain: "<?= dbName ?>.firebaseapp.com",
       	databaseURL: "https://<?= dbName ?>.firebaseio.com",
       	projectId: "<?= dbName ?>",
       	storageBucket: "<?= dbName ?>.appspot.com",
       	messagingSenderId: "924659512730",
        sidebarNetworkErrorMsg:"There is a problem with the network, please try again later."
       };
       firebase.initializeApp( config );
       //-----------------------------------------------------------------
       // END Initialize Firebase
       //-----------------------------------------------------------------


       /**
        * show the loading spinner
        * @param {array(string)} loadingTextStrings array with the loading texts to show during the loading
        */
       showLoading = function(loadingTextStrings) {
         loadingTextStrings=(loadingTextStrings || ["Loading"]);
         $('#loadingText').empty().append("<h4></h4>");
         $('#loadingText h4').slideTextLeft(loadingTextStrings);
         $('#loading').show();
       };

       /**
        * callBack For All google script calls
        */
       hideLoading = function() {
          $('#loading').hide();
       };

       /**
        * callback WITH PROTECTION SHEET
        * @deprecated not used
        */
       hideLoadingWithProtection = function() {
         //this protect the sheet and avoid script error
         google.script.run.withSuccessHandler(hideLoadingDiv).LIB_FUNC( "AmisMarketApp.protectSheet");
       };

       hideLoadingWithLoadData = function() {
         //this protect the sheet and avoid script error
         google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.SyncMasterSheet.startFetchMaster",'',true, $( "#countryName" ).val(),false);
       };

         hideLoadingWithDeleteData = function() {
         //this protect the sheet and avoid script error
         google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.SyncMasterSheet.startFetchMaster",'',true, $( "#countryName" ).val(),true);
       };



       /**
        * hide the loading spinner
        */
       hideLoadingDiv = function() {
         $('#loading').hide();
       };




       /**
        * onLogged events
        * @param  {object} user The signed-in user info
        * @param  {function} onSuccess callback called if successfully logged in
        */
       function onLoggedState(user, onSuccess){
           onSuccess=(onSuccess || function(){});
           console.log( 'user logged', user );

           //change the sidebarmenu
           //google.script.run.changeSidebar();

           //----------------------------------
           //hide form show menu logged in
           //----------------------------------
           //google.script.run.hideShow();
           firebase.database().ref('/users_data/' + user.uid).once('value').then(function(snapshot) {
             user_data = snapshot.val();

             if(!user_data){
                 //alert("User "+user.email+" is not authorized!");
                 google.script.run.LIB_FUNC( "AmisMarketApp.Utility.popUpAlert", "User "+user.email+" is not authorized!");
                 google.script.host.close();
                 return;
             }
             console.log('USER_DATA', user_data);

             $(".isSecretariat").toggle(user_data.type==="secretariat");

             if ( user_data.type==="admin" ) {
                 //show create country sheet
                 $( "#create-sheet-form" ).show();
             } else {
                 //show normal menu
                 $( "#userActionsDiv" ).show();
             }

             //set user name into label
             $( "#userLabel" ).text( user.email );
             $( "#loading" ).hide();

             //----------------------------------
             //END --hide form show menu logged in
             //----------------------------------

             console.info( 'user', user.uid );
             //.then is used to get the token value
             user.getToken().then( function( data ) {
                 userToken=data;

                 console.log( 'gettoken', data );
                 google.script.run.LIB_FUNC( "AmisMarketApp.FirebaseConnector.setToken", data );

                 // Store in session the token
                 google.script.run.LIB_FUNC( "AmisMarketApp.onLogin" );

                 onSuccess();
             } );
         });
       }

       /**
        * verify the token, refresh it  if expired then call the callback
        * @param  {Function} callback
        */
       function verifyToken(callback) {
       	firebase.auth().currentUser.getToken( /* forceRefresh */).then( function( idToken ) {
       		callback();
       	} ).catch( function( error ) {
            //refresh the token
            firebase.auth().currentUser.getToken(true).then(function(idToken) {
                console.log('refresh token ok', idToken);
                google.script.run.LIB_FUNC( "AmisMarketApp.FirebaseConnector.setToken", idToken );
                callback();
            }).catch(function(error) {
                console.log('refresh token ko', error);
            });
       	} );
       }

       /**
        * show a popup with the google login
        * @param  {function} onSuccess callback called if successfully logged in
        */
       function loginWithGoogle(onSuccess) {
            onSuccess=(onSuccess || function(){});
           	var provider = new firebase.auth.GoogleAuthProvider();

           	firebase.auth().signInWithPopup( provider ).then( function( result ) {
                onLoggedState(result.user, onSuccess);
           	} ).catch( function( error ) {
                console.log('ERROR', error);

                if (error.hasOwnProperty("code") && error.code==="auth/operation-not-supported-in-this-environment") {
                    google.script.run.LIB_FUNC("AmisMarketApp.Utility.popUpAlert", "Your browser is not supported. Please use Chrome or Firefox.");
                    google.script.host.close();
                    return;
                }

           		//alert("User "+error.email+" is not authorized!");
                google.script.run.LIB_FUNC( "AmisMarketApp.Utility.popUpAlert",'Something went wrong with the login or the network doen\'t work.\\nPlease ensure that popup lock is DISABLED. Then try again.');
           		// Handle Errors here.
           		var errorCode = error.code;
           		var errorMessage = error.message;
           		// The email of the user's account used.
           		var email = error.email;
           		// The firebase.auth.AuthCredential type that was used.
           		var credential = error.credential;

                var debugMailMsg=
                "Google Login failed <br>"+
                "<b>errorCode</b>: " + error.code+"<br>"+
           		"<b>errorMessage</b>: " + error.message+"<br>"+
           		"<b>email</b>: " + error.email+"<br>"+
           		"<b>credential</b>: " + error.credential;

                debugEmail(debugMailMsg);

           	} );
       }

       /**
        * send a debug email with as much as info as possible
        * @param  {string} msg detail to add to the email
        * @return {void}
        */
       function debugEmail(msg) {
           var emailMsg="";

           emailMsg=msg+"<br>"+
            "<b>User agent</b>: "+navigator.userAgent+"<br>"+
            "<b>Sidebar Stacktrace</b>: "+(new Error()).stack;


           google.script.run.LIB_FUNC( "AmisMarketApp.Utility.sendErrorEmails", emailMsg);
       }



       /**
        * not used in the code, just for use in the browser console
        */
       function logout(){
           firebase.auth().signOut()
       }

      /**
       * sets a wrong token (development use)
       */
      function wrongToken(){
          google.script.run.LIB_FUNC( "AmisMarketApp.FirebaseConnector.setToken", 123 );
          userToken=123;
          console.log("Set a wrong token");
      }

      /**
       * save all the data in all sheets to firebase
       * @return {void}
       */
      function saveAllSheet() {
          showLoading(["Saving data", "Sending data to the database", "Synchronizing the sheet"]);
          google.script.run
            .withSuccessHandler(hideLoading)
            .withFailureHandler( function(error){
                if (error.message==="InvalidSheetData") {
                    hideLoading();
                } else {
                    googleScriptRunFailureHandler(saveAllSheet)(error);
                }
            } )
            .LIB_FUNC( "AmisMarketApp.SyncMasterSheet.startSync", userToken );
          //disable the button himself
          $( "#addFrcA" ).prop( "disabled", false );
          $( "#addFrcB" ).prop( "disabled", false );
      }


      /**
       * verify the data on the sheet
       */
      function verifySheet() {
          showLoading(["Verifying the sheet", "Doing a style check", "Rastoring the formulas", "Checking the values"]);

          google.script.run
            .withSuccessHandler(hideLoading)
            .withFailureHandler(hideLoading)
            .LIB_FUNC( "AmisMarketApp.ProtectionMaker.validateSheet" );
      }

      /**
       * overwrite sheet's data with firebase data
       * @param {object} event jQuery event
       * @param  {bool} forceload (default false) if true doesn't ask the user for loading data
       * @return {void}
       */
      function fetchData(event,forceload) {
		  forceload=(forceload || false);

          showLoading(["Loading data from the database", "Synchronizing the sheet"]);
          google.script.run
          	.withSuccessHandler( hideLoading )
            .withFailureHandler( googleScriptRunFailureHandler(function(){
                fetchData(null, true);
            }))
          	.LIB_FUNC( "AmisMarketApp.SyncMasterSheet.startFetch", userToken, forceload );
      }

      /**
      * show old forecast
      * @return {void}
      */
      function showHistoricalSeries() {
          showLoading(["Showing historical series"]);
          google.script.run.withSuccessHandler( hideLoading ).LIB_FUNC( "AmisMarketApp.ForecastUtility.showOldForecasts" );
      }
      /**
      * hoide old forecast
      * @return {void}
      */
      function hideHistoricalSeries() {
          showLoading(["Hiding historical series","Hiding forecasts"]);
          google.script.run.withSuccessHandler( hideLoading ).LIB_FUNC( "AmisMarketApp.ForecastUtility.hideOldAndUnactiveForecast", userToken );
      }

      /**
       * closure failure handler to manage network Errors
       * @param  {function} retryCalback callback to execute after successfully refreshed the token
       * @return {function}              the failure callback
       */
      function googleScriptRunFailureHandler( retryCalback ) {
          return function(error){
              error=(error || "");
              //token expired
              if ( error.hasOwnProperty( "message" ) && ( error.message === "Network401Error" ) ) {
                  loginWithGoogle(retryCalback);
              } else {
                  alert( config.sidebarNetworkErrorMsg );
                  hideLoading();
              }
          };
      }

      /**
       * create google sheet function
       * @return {void}
       */
      function createSheet() {
         var countryName = $( "#countryName" ).val();
         var account = $( "#account" ).val();
         //prevent redirect actions
         showLoading(["Creating the sheet", "Sharing the sheet with the user", "Sending the email to the user"]);
         google.script.run
         .withSuccessHandler( hideLoadingWithDeleteData )
         .withFailureHandler( googleScriptRunFailureHandler(createSheet) )
         .LIB_FUNC( "AmisMarketApp.ShareSheet.createSheet", countryName, account, userToken );
         return false;
      }


      /**
       * change event on COUNTRY SELECTED
       * @param {object} event the event
       * @return {void}
       */
      function countryChange(event) {
          //selected value
          var valueSelected = event.target.value;
          if(valueSelected != '') {
              showLoading(["Updating Master","Updating Master"]);
              google.script.run
              .withSuccessHandler(hideLoadingWithLoadData)
              .withFailureHandler( googleScriptRunFailureHandler(function(){
                  countryChange(event);
              }))
              .LIB_FUNC("AmisMarketApp.MasterUtility.writeNoteAndDataForCountriesMaster",valueSelected,false);
          }
      }

      /**
       * start the excel exportation and download the generated excel file
       * @return {void}
       */
      function excelExport() {
          //prevent redirect actions
          showLoading(["Creating the excel file", "writing data to the excel file", "Prepare the file to download"]);
          google.script.run
          .withSuccessHandler(function(spreadSheetId){
              window.location='https://docs.google.com/spreadsheets/d/'+spreadSheetId+'/export?exportFormat=xlsx';
              hideLoading();
          })
          .withFailureHandler( googleScriptRunFailureHandler(excelExport))
          .LIB_FUNC("AmisMarketApp.ExcelExport.startExport",userToken);
      }



       $( document ).ready( function() {
           var unsubOnAuthStateChanged=firebase.auth().onAuthStateChanged(function(user) {
             console.log('UNSUBONAUTHSTATECHANGED');
             window.user=user;
            //  unsubOnAuthStateChanged();
             if (user) {
                 console.log('USER authenticated', user);
                onLoggedState(user);
             } else {
                loginWithGoogle();
             }
           });

           //binding SAVE function with AMIS MARKET API
           $( "#buttonSave" ).click(saveAllSheet);

           $("#buttonVerify").click(verifySheet);

           $( "#addFrcA" ).bind( "click", function() {

               showLoading(["Loading sheet's data","Creating the new forecast", "Saving the data", "Sending data to the database"]);
               verifyToken(function(){
                  //google.script.run.withSuccessHandler(hideLoadingWithProtection).LIB_FUNC( "AmisMarketApp.ForecastUtility.addForecast16_17", userToken);
                  google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.ForecastUtility.addNewForecast", 0);
              });

               //disable the button himself
               $( "#addFrcA" ).prop( "disabled", true );
           } );
           $( "#addFrcB" ).bind( "click", function() {

               showLoading(["Loading sheet's data","Creating the new forecast", "Saving the data", "Sending data to the database"]);
               verifyToken(function(){
                  //google.script.run.withSuccessHandler(hideLoadingWithProtection).LIB_FUNC( "AmisMarketApp.ForecastUtility.addForecast17_18", userToken);
                  google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.ForecastUtility.addNewForecast", 1);
                });

               //disable the button himself
               $( "#addFrcB" ).prop( "disabled", true );
           } );
           //binding FETCH function with AMIS MARKET API
           $("#buttonFetch").click(fetchData);

           //bind create google sheet function
           $( "#createSheetButton" ).click( createSheet);


           //bind Show/hide historical series
           $("#showHistoricalSeries").click(showHistoricalSeries);
           $("#hideHistoricalSeries").click(hideHistoricalSeries);

           //on change event on COUNTRY SELECTED
           $("#countryName").change(countryChange);

           //start the excel exportation and download the generated excel file
           $("#excelExportBtn").click(excelExport);


       } )
</script>
