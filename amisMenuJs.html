<script>
        var hideLoading, showLoading;

       //-----------------------------------------------------------------
       // Initialize Firebase
       //-----------------------------------------------------------------
       var config = {
       	apiKey: "<?= apiKey ?>",
       	authDomain: "<?= dbName ?>.firebaseapp.com",
       	databaseURL: "https://<?= dbName ?>.firebaseio.com",
       	projectId: "<?= dbName ?>",
       	storageBucket: "<?= dbName ?>.appspot.com",
       	messagingSenderId: "924659512730"
       };
       firebase.initializeApp( config );
       //-----------------------------------------------------------------
       // END Initialize Firebase
       //-----------------------------------------------------------------


       /**
        * show the loading spinner
        */
       showLoading = function() {
         $('#loading').show();
       };

       /**
        * hide the loading spinner
        */
       hideLoading = function() {
         $('#loading').hide();
       };


       /**
        * onLogged events
        * @param  {object} user The signed-in user info
        */
       function onLoggedState(user){

           //change the sidebarmenu
           //google.script.run.changeSidebar();

           //----------------------------------
           //hide form show menu logged in
           //----------------------------------
           //google.script.run.hideShow();
           firebase.database().ref('/users_data/' + user.uid).once('value').then(function(snapshot) {
             var user_data = snapshot.val();

             if(!user_data){
                 //alert("User "+user.email+" is not authorized!");
                 google.script.run.LIB_FUNC( "AmisMarketApp.Utility.popUpAlert");
                 return;
             }
             console.log('USER_DATA', user_data);

             if ( user_data.type==="admin" ) {
                 //show create country sheet
                 $( "#create-sheet-form" ).show();
             } else {
                 //show normal menu
                 $( "#userActionsDiv" ).show();
             }

             //set user name into label
             $( "#userLabel" ).text( user.email );
             $( "#loading" ).hide();

             //----------------------------------
             //END --hide form show menu logged in
             //----------------------------------

             console.info( 'user', user.uid );
             //.then is used to get the token value
             user.getToken().then( function( data ) {

             if ( user_data.type!="admin" ) {
                //automatic fetch for operative users
                showLoading();
                google.script.run.withSuccessHandler(hideLoading).LIB_FUNC("AmisMarketApp.SyncMasterSheet.startFetch",data);
             }
                 console.log( 'gettoken', data );
                 google.script.run.LIB_FUNC( "AmisMarketApp.FirebaseConnector.setToken", data );
                 // Store in session the token
                 google.script.run.LIB_FUNC( "AmisMarketApp.onLogin" );
                 google.script.run.LIB_FUNC( "AmisMarketApp.protectSheet",data );
                 //binding SAVE function with AMIS MARKET API
                 $( "#buttonSave" ).bind( "click", function() {
                     //google.script.run.startSync(data);
                     showLoading();
                     google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.SyncMasterSheet.startSync", data );
                     //disable the button himself
                     $( "#addFrc16" ).prop( "disabled", false );
                     $( "#addFrc17" ).prop( "disabled", false );
                 } );
                 $( "#addFrc16" ).bind( "click", function() {
                     //google.script.run.addForecast(data);
                     showLoading();
                     google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.ForecastUtility.addForecast", "16-17", data );
                     //disable the button himself
                     $( "#addFrc16" ).prop( "disabled", true );
                 } );
                 $( "#addFrc17" ).bind( "click", function() {
                     //google.script.run.addForecast(data);
                     showLoading();
                     google.script.run.withSuccessHandler(hideLoading).LIB_FUNC( "AmisMarketApp.ForecastUtility.addForecast", "17-18", data );
                     //disable the button himself
                     $( "#addFrc17" ).prop( "disabled", true );
                 } );
                 //binding FETCH function with AMIS MARKET API
                 $("#buttonFetch").bind( "click", function() {
                     showLoading();
                     google.script.run.withSuccessHandler(hideLoading).LIB_FUNC("AmisMarketApp.SyncMasterSheet.startFetch",data);
                 });
                 //bind create google sheet function
                 $( "#createSheetButton" ).bind( "click", function() {
                 	var countryName = $( "#countryName" ).val();
                 	var account = $( "#account" ).val();
                 	//prevent redirect actions
                 	//google.script.run.createSheet(countryName,account);
                 	showLoading();
                 	google.script.run.withSuccessHandler( hideLoading ).LIB_FUNC( "AmisMarketApp.ShareSheet.createSheet", countryName, account, data );
                 	return false;
                 } );


             } );
         });
       }




       /**
        * show a popup with the google login
        */
       function loginWithGoogle() {
       	var provider = new firebase.auth.GoogleAuthProvider();
       	firebase.auth().signInWithRedirect( provider );
        google.script.run.LIB_FUNC("AmisMarketApp.Utility.openSidebar");
       }



       /**
        * not used in the code, just for use in the browser console
        */
       function logout(){
           firebase.auth().signOut()
           console.log("logged out");
       }




       $( document ).ready( function() {
           console.log('WINDOW.LOCATION.HREF', window.location.href);
           var unsubOnAuthStateChanged=firebase.auth().onAuthStateChanged(function(user) {
             unsubOnAuthStateChanged();
             if (user) {
                 console.log('USER authenticated', user);
                onLoggedState(user);
             } else {
                 console.log("unsubOnAuthStateChanged ko");
                 setTimeout(function () {
                     loginWithGoogle();
                 }, 500);
             }
           });


        //    firebase.auth().getRedirectResult().then( function( result ) {
        //        	// The signed-in user info.
        //        	var user = result.user;
        //        	console.log( 'USER authenticated', user );
        //    	 //    if (user) {
        //    	 //        onLoggedState( user );
        //    	 //    } else {
        //    	 //        loginWithGoogle();
        //    	 //    }
        //    } ).catch( function( error ) {
        //        	console.log( 'ERROR', error );
        //         // loginWithGoogle();
        //    } );



       } )
</script>
